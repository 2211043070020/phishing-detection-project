<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phishing Detection Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 380px;
            min-height: 500px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            color: #333;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .loading .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-container {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .status-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .status-safe {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .status-warning {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }

        .status-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .site-url {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            word-break: break-all;
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .risk-percentage {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .risk-safe { color: #4CAF50; }
        .risk-warning { color: #FF9800; }
        .risk-danger { color: #f44336; }

        .features-container {
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .features-grid {
            display: grid;
            gap: 8px;
        }

        .feature-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
        }

        .feature-item:hover {
            background: #e9ecef;
        }

        .feature-safe {
            border-left-color: #4CAF50;
        }

        .feature-warning {
            border-left-color: #FF9800;
        }

        .feature-danger {
            border-left-color: #f44336;
        }

        .feature-name {
            font-size: 13px;
            font-weight: 500;
            color: #333;
        }

        .feature-value {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            min-width: 60px;
            text-align: center;
        }

        .value-safe {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .value-warning {
            background: #fff3e0;
            color: #ef6c00;
        }

        .value-danger {
            background: #ffebee;
            color: #c62828;
        }

        .action-buttons {
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #eee;
        }

        .action-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            text-align: center;
            display: block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .model-info {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            font-size: 11px;
            color: #666;
        }

        .model-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .model-info-item {
            display: flex;
            justify-content: space-between;
        }

        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .no-data .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            margin: 10px;
            border-radius: 6px;
            font-size: 12px;
            border-left: 4px solid #f44336;
        }

        /* Scrollbar styling */
        .features-container::-webkit-scrollbar {
            width: 6px;
        }

        .features-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .features-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .features-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è Phishing Detection Tool</h1>
        </header>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Analyzing website security...</p>
        </div>

        <div id="main-content" style="display: none;">
            <div class="result-container">
                <div id="status-circle" class="status-circle status-safe">
                    ‚úì
                </div>
                <div id="site-url" class="site-url">
                    Loading...
                </div>
                <div id="risk-percentage" class="risk-percentage risk-safe">
                    Loading...
                </div>
                <div id="status-message" style="font-size: 14px; color: #666;">
                    Analyzing...
                </div>
            </div>

            <div class="features-container">
                <div id="features-grid" class="features-grid">
                    <!-- Features will be populated by JavaScript -->
                </div>
            </div>

            <div class="action-buttons">
                <a href="dns.html" class="action-button btn-primary">
                    DNS Analysis
                </a>
                <button id="refresh-btn" class="action-button btn-secondary">
                    Refresh
                </button>
            </div>

            <div class="model-info">
                <div class="model-info-grid">
                    <div class="model-info-item">
                        <span>Model:</span>
                        <span id="model-type">CatBoost</span>
                    </div>
                    <div class="model-info-item">
                        <span>Accuracy:</span>
                        <span>94.97%</span>
                    </div>
                    <div class="model-info-item">
                        <span>Version:</span>
                        <span id="model-version">1.0</span>
                    </div>
                    <div class="model-info-item">
                        <span>Updated:</span>
                        <span id="model-updated">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="no-data" class="no-data" style="display: none;">
            <div class="icon">üåê</div>
            <h3>No Website Data</h3>
            <p>Please visit a website to see security analysis</p>
            <button id="reload-tab-btn" class="action-button btn-primary" style="margin-top: 15px; width: auto; padding: 8px 20px;">
                Reload Current Tab
            </button>
        </div>

        <div id="error-container" style="display: none;">
            <div class="error-message">
                <strong>Analysis Error</strong><br>
                <span id="error-text">Unable to analyze website security</span>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTabId = null;
        let analysisData = null;

        // Initialize popup
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initializePopup();
            } catch (error) {
                console.error('Error initializing popup:', error);
                showError('Failed to initialize security analysis');
            }
        });

        async function initializePopup() {
            // Get current active tab
            const tabs = await chrome.tabs.query({active: true, currentWindow: true});
            if (tabs.length === 0) {
                showNoData();
                return;
            }

            currentTabId = tabs[0].id;
            const currentUrl = tabs[0].url;

            // Check if we can analyze this URL
            if (!canAnalyzeUrl(currentUrl)) {
                showNoData('This page cannot be analyzed (browser internal page)');
                return;
            }

            // Try to get existing analysis data
            try {
                const result = await chrome.storage.local.get([`prediction_${currentTabId}`]);
                const predictionData = result[`prediction_${currentTabId}`];

                if (predictionData && isDataFresh(predictionData.timestamp)) {
                    analysisData = predictionData;
                    displayAnalysis();
                } else {
                    // Request fresh analysis
                    await requestAnalysis();
                }
            } catch (error) {
                console.error('Error getting analysis data:', error);
                await requestAnalysis();
            }

            // Load model info
            await loadModelInfo();
        }

        function canAnalyzeUrl(url) {
            const unanalyzableUrls = [
                'chrome://',
                'chrome-extension://',
                'moz-extension://',
                'edge://',
                'about:',
                'file://'
            ];

            return !unanalyzableUrls.some(prefix => url.startsWith(prefix));
        }

        function isDataFresh(timestamp) {
            const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
            return timestamp > fiveMinutesAgo;
        }

        async function requestAnalysis() {
            try {
                // Send message to content script to extract features
                await chrome.tabs.sendMessage(currentTabId, {action: 'extract_features'});
                
                // Wait for analysis to complete
                setTimeout(async () => {
                    try {
                        const result = await chrome.storage.local.get([`prediction_${currentTabId}`]);
                        const predictionData = result[`prediction_${currentTabId}`];
                        
                        if (predictionData) {
                            analysisData = predictionData;
                            displayAnalysis();
                        } else {
                            showNoData('Analysis in progress...');
                            // Try again after a longer delay
                            setTimeout(checkAnalysisAgain, 3000);
                        }
                    } catch (error) {
                        console.error('Error getting analysis results:', error);
                        showError('Analysis failed to complete');
                    }
                }, 2000);

            } catch (error) {
                console.error('Error requesting analysis:', error);
                showError('Could not start website analysis');
            }
        }

        async function checkAnalysisAgain() {
            try {
                const result = await chrome.storage.local.get([`prediction_${currentTabId}`]);
                const predictionData = result[`prediction_${currentTabId}`];
                
                if (predictionData) {
                    analysisData = predictionData;
                    displayAnalysis();
                } else {
                    showNoData('Unable to analyze this website');
                }
            } catch (error) {
                showError('Analysis timeout');
            }
        }

        function displayAnalysis() {
            if (!analysisData) {
                showNoData();
                return;
            }

            hideLoading();
            showMainContent();

            // Update URL
            document.getElementById('site-url').textContent = analysisData.url || 'Current Website';

            // Update risk status
            const legitimatePercentage = analysisData.legitimatePercentage || 50;
            const riskLevel = getRiskLevel(legitimatePercentage);
            
            updateStatusCircle(riskLevel, legitimatePercentage);
            updateRiskPercentage(legitimatePercentage, riskLevel);
            
            // Update features
            if (analysisData.features) {
                displayFeatures(analysisData.features);
            }
        }

        function getRiskLevel(legitimatePercentage) {
            if (legitimatePercentage >= 70) return 'safe';
            if (legitimatePercentage >= 40) return 'warning';
            return 'danger';
        }

        function updateStatusCircle(riskLevel, percentage) {
            const circle = document.getElementById('status-circle');
            const message = document.getElementById('status-message');
            
            circle.className = `status-circle status-${riskLevel}`;
            
            switch (riskLevel) {
                case 'safe':
                    circle.textContent = '‚úì';
                    message.textContent = 'Website appears legitimate';
                    message.style.color = '#4CAF50';
                    break;
                case 'warning':
                    circle.textContent = '‚ö†';
                    message.textContent = 'Exercise caution with this website';
                    message.style.color = '#FF9800';
                    break;
                case 'danger':
                    circle.textContent = '‚úï';
                    message.textContent = 'High risk - potential phishing site';
                    message.style.color = '#f44336';
                    break;
            }
        }

        function updateRiskPercentage(percentage, riskLevel) {
            const element = document.getElementById('risk-percentage');
            element.textContent = `${Math.round(percentage)}% Legitimate`;
            element.className = `risk-percentage risk-${riskLevel}`;
        }

        function displayFeatures(features) {
            const grid = document.getElementById('features-grid');
            grid.innerHTML = '';

            const featureNames = {
                'IP Address': 'IP Address Usage',
                'URL Length': 'URL Length',
                'Short URL': 'URL Shortening',
                '@': '@ Symbol in URL',
                'Redirecting //': 'URL Redirects',
                'Prefix/Suffix': 'Domain Hyphens',
                'Sub Domains': 'Subdomain Count',
                'HTTPS in Domain': 'HTTPS in Domain',
                'SSL Certificate': 'SSL Certificate',
                'Request URL': 'External Resources',
                'Anchor': 'External Links',
                'Script and Link': 'External Scripts',
                'SFH': 'Form Handlers',
                'mailto': 'Email Forms',
                'iFrames': 'Hidden Frames',
                'Favicon': 'Favicon Source',
                'Port': 'Network Port',
                'DNS Analysis': 'DNS Security'
            };

            for (const [key, value] of Object.entries(features)) {
                const displayName = featureNames[key] || key;
                const featureElement = createFeatureElement(displayName, value);
                grid.appendChild(featureElement);
            }
        }

        function createFeatureElement(name, value) {
            const item = document.createElement('div');
            item.className = 'feature-item';
            
            const numValue = parseFloat(value);
            let riskClass, valueText, valueClass;
            
            if (numValue < 0) {
                riskClass = 'feature-safe';
                valueClass = 'value-safe';
                valueText = 'Safe';
            } else if (numValue === 0) {
                riskClass = 'feature-warning';
                valueClass = 'value-warning';
                valueText = 'Neutral';
            } else {
                riskClass = 'feature-danger';
                valueClass = 'value-danger';
                valueText = 'Risk';
            }
            
            item.classList.add(riskClass);
            
            item.innerHTML = `
                <span class="feature-name">${name}</span>
                <span class="feature-value ${valueClass}">${valueText}</span>
            `;
            
            return item;
        }

        async function loadModelInfo() {
            try {
                const modelInfo = await chrome.runtime.sendMessage({action: 'get_model_info'});
                
                if (modelInfo && !modelInfo.error) {
                    document.getElementById('model-type').textContent = modelInfo.modelType || 'CatBoost';
                    document.getElementById('model-version').textContent = modelInfo.version || '1.0';
                    document.getElementById('model-updated').textContent = modelInfo.lastUpdate || 'Unknown';
                } else {
                    document.getElementById('model-updated').textContent = 'Error loading';
                }
            } catch (error) {
                console.error('Error loading model info:', error);
                document.getElementById('model-updated').textContent = 'Error';
            }
        }

        function showMainContent() {
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('no-data').style.display = 'none';
            document.getElementById('error-container').style.display = 'none';
        }

        function showNoData(message = null) {
            document.getElementById('no-data').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('error-container').style.display = 'none';
            
            if (message) {
                document.querySelector('#no-data p').textContent = message;
            }
        }

        function showError(message) {
            document.getElementById('error-container').style.display = 'block';
            document.getElementById('error-text').textContent = message;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('no-data').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Event listeners
        document.getElementById('refresh-btn').addEventListener('click', async function() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';
            
            // Clear cached data
            if (currentTabId) {
                await chrome.storage.local.remove([`prediction_${currentTabId}`]);
            }
            
            // Request fresh analysis
            setTimeout(() => requestAnalysis(), 500);
        });

        document.getElementById('reload-tab-btn').addEventListener('click', async function() {
            if (currentTabId) {
                await chrome.tabs.reload(currentTabId);
                window.close();
            }
        });

        console.log('Extension UI script loaded');
    </script>
</body>
</html>
